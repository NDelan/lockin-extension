/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,o)}return r}function r(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?e(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(e,r,o){return(r=function(e){var r=function(e){if("object"!=t(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,"string");if("object"!=t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[r]=o,e}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=Array(e);r<e;r++)o[r]=t[r];return o}var i=function(t){return new Promise((function(e){chrome.storage.local.get(["focusSessions"],(function(o){var i,a=o.focusSessions||[],c=[].concat((i=a,function(t){if(Array.isArray(t))return n(t)}(i)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(i)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(i)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),[r(r({},t),{},{id:Date.now().toString(),completed:!0})]).slice(-500);chrome.storage.local.set({focusSessions:c},(function(){return e(c)}))}))}))},a=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise((function(r){chrome.storage.local.get([t],(function(o){r(void 0!==o[t]?o[t]:e)}))}))};function c(t){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c(t)}function s(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return l(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?l(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=Array(e);r<e;r++)o[r]=t[r];return o}function u(){u=function(){return e};var t,e={},r=Object.prototype,o=r.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function f(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{f({},"")}catch(t){f=function(t,e,r){return t[e]=r}}function m(t,e,r,o){var i=e&&e.prototype instanceof b?e:b,a=Object.create(i.prototype),c=new M(o||[]);return n(a,"_invoke",{value:j(t,r,c)}),a}function d(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=m;var h="suspendedStart",g="suspendedYield",p="executing",v="completed",y={};function b(){}function O(){}function S(){}var w={};f(w,a,(function(){return this}));var P=Object.getPrototypeOf,E=P&&P(P(R([])));E&&E!==r&&o.call(E,a)&&(w=E);var k=S.prototype=b.prototype=Object.create(w);function A(t){["next","throw","return"].forEach((function(e){f(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(n,i,a,s){var l=d(t[n],t,i);if("throw"!==l.type){var u=l.arg,f=u.value;return f&&"object"==c(f)&&o.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(f).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(l.arg)}var i;n(this,"_invoke",{value:function(t,o){function n(){return new e((function(e,n){r(t,o,e,n)}))}return i=i?i.then(n,n):n()}})}function j(e,r,o){var n=h;return function(i,a){if(n===p)throw Error("Generator is already running");if(n===v){if("throw"===i)throw a;return{value:t,done:!0}}for(o.method=i,o.arg=a;;){var c=o.delegate;if(c){var s=D(c,o);if(s){if(s===y)continue;return s}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(n===h)throw n=v,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);n=p;var l=d(e,r,o);if("normal"===l.type){if(n=o.done?v:g,l.arg===y)continue;return{value:l.arg,done:o.done}}"throw"===l.type&&(n=v,o.method="throw",o.arg=l.arg)}}}function D(e,r){var o=r.method,n=e.iterator[o];if(n===t)return r.delegate=null,"throw"===o&&e.iterator.return&&(r.method="return",r.arg=t,D(e,r),"throw"===r.method)||"return"!==o&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+o+"' method")),y;var i=d(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function T(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function M(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(T,this),this.reset(!0)}function R(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function r(){for(;++n<e.length;)if(o.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(c(e)+" is not iterable")}return O.prototype=S,n(k,"constructor",{value:S,configurable:!0}),n(S,"constructor",{value:O,configurable:!0}),O.displayName=f(S,l,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===O||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,S):(t.__proto__=S,f(t,l,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},A(x.prototype),f(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,o,n,i){void 0===i&&(i=Promise);var a=new x(m(t,r,o,n),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},A(k),f(k,l,"Generator"),f(k,a,(function(){return this})),f(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var o in e)r.push(o);return r.reverse(),function t(){for(;r.length;){var o=r.pop();if(o in e)return t.value=o,t.done=!1,t}return t.done=!0,t}},e.values=R,M.prototype={constructor:M,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var r in this)"t"===r.charAt(0)&&o.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(o,n){return c.type="throw",c.arg=e,r.next=o,n&&(r.method="next",r.arg=t),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],c=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var s=o.call(a,"catchLoc"),l=o.call(a,"finallyLoc");if(s&&l){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&o.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),L(r),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var o=r.completion;if("throw"===o.type){var n=o.arg;L(r)}return n}}throw Error("illegal catch attempt")},delegateYield:function(e,r,o){return this.delegate={iterator:R(e),resultName:r,nextLoc:o},"next"===this.method&&(this.arg=t),y}},e}function f(t,e,r,o,n,i,a){try{var c=t[i](a),s=c.value}catch(t){return void r(t)}c.done?e(s):Promise.resolve(s).then(o,n)}function m(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,o)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?m(Object(r),!0).forEach((function(e){h(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function h(t,e,r){return(e=function(t){var e=function(t){if("object"!=c(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=c(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==c(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var g=!1;function p(){console.log("Ending focus session"),chrome.storage.local.get(["timerState"],(function(t){if(t.timerState){var e=t.timerState.savedType||"POMODORO",r=25;"SHORT_BREAK"===e?r=5:"LONG_BREAK"===e&&(r=15),g=!1;var o={savedType:e,savedMinutes:r,savedSeconds:0,savedIsActive:!1,endTime:null,pausedAt:Date.now(),taskId:t.timerState.taskId};chrome.storage.local.set({timerState:o}),chrome.alarms.clear("pomodoroEnd"),chrome.action.setBadgeText({text:""})}}))}function v(t,e){console.log("Timer completed:",t),"POMODORO"===t&&(g=!1,new Promise((function(t){chrome.storage.local.get(["currentSession","settings"],(function(e){if(e.currentSession){var o,n=e.currentSession,a=e.settings||{};"POMODORO"===n.type?o=a.pomodoroMinutes||25:"SHORT_BREAK"===n.type?o=a.shortBreakMinutes||5:"LONG_BREAK"===n.type&&(o=a.longBreakMinutes||15);var c=r(r({},n),{},{endTime:Date.now(),duration:o,completed:!0});"POMODORO"===n.type?i(c).then((function(){chrome.storage.local.remove(["currentSession"]),t(c)})):(chrome.storage.local.remove(["currentSession"]),t(c))}else t(null)}))})).catch((function(t){console.error("Error tracking session completion:",t)})),p()),chrome.notifications.create("timer-completed-notification",{type:"basic",iconUrl:"/assets/icons/icon128.png",title:"".concat(t," Completed!"),message:"POMODORO"===t?"Time for a break!":"Ready to focus again?"}),chrome.action.setBadgeText({text:""})}chrome.runtime.onInstalled.addListener((function(){console.log("LockIn extension installed"),chrome.storage.local.set({notificationSettings:{allowFrom:["Gmail"],enableDuringBreaks:!0},notifications:[],blockedNotifications:[],notificationStats:{gmail:0,calendar:0}}),chrome.storage.local.get(["tasks"],(function(t){t.tasks||chrome.storage.local.set({focusSessions:[],tasks:{inProgress:[],toDo:[],completed:[],backlog:[]}})})),function(){if(chrome.notifications){console.log("Setting up notification interception");var t=chrome.notifications.create;chrome.notifications.create=function(){var e,r,o,n,i,a=Array.from(arguments);1===a.length?n=a[0]:2===a.length?"function"==typeof a[1]?(n=a[0],i=a[1]):(o=a[0],n=a[1]):3===a.length&&(o=a[0],n=a[1],i=a[2]),"focus-mode-notification"===o||"timer-completed-notification"===o||"Focus Mode Activated"===(null===(e=n)||void 0===e?void 0:e.title)||null!==(r=n)&&void 0!==r&&null!==(r=r.title)&&void 0!==r&&r.includes("Completed")?o?t(o,n,i):i?t(n,i):t(n):b("System").then((function(e){var r,a,c;if(e)return console.log("Blocking notification in focus mode:",null===(r=n)||void 0===r?void 0:r.title),O({source:"System",message:(null===(a=n)||void 0===a?void 0:a.title)||"Notification blocked",details:(null===(c=n)||void 0===c?void 0:c.message)||""}),void(i&&i(""));o?t(o,n,i):i?t(n,i):t(n)}))}}}()})),chrome.runtime.onMessage.addListener((function(t,e,r){if(console.log("Received message:",t.action),"START_POMODORO"===t.action)!function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"POMODORO";console.log("Starting focus session:",e),chrome.storage.local.get(["timerState","settings"],(function(r){var o,n=r.settings||{};"POMODORO"===e?o=60*(n.pomodoroMinutes||25)*1e3:"SHORT_BREAK"===e?o=60*(n.shortBreakMinutes||5)*1e3:"LONG_BREAK"===e&&(o=60*(n.longBreakMinutes||15)*1e3);var i=Date.now()+o;g=!0;var a={savedType:e||"POMODORO",savedMinutes:Math.floor(o/6e4),savedSeconds:0,savedIsActive:!0,endTime:i,pausedAt:null,taskId:t};chrome.storage.local.set({timerState:a,activeTimer:t}),"POMODORO"===e&&function(t,e){return new Promise((function(r){var o={id:Date.now().toString(),taskId:t,type:e,startTime:Date.now(),completed:!1};chrome.storage.local.get(["currentSession"],(function(t){chrome.storage.local.set({currentSession:o},(function(){return r(o)}))}))}))}(t,e).catch((function(t){console.error("Error tracking session start:",t)})),chrome.alarms.clear("pomodoroEnd"),chrome.alarms.create("pomodoroEnd",{when:i}),chrome.notifications.create("focus-mode-notification",{type:"basic",iconUrl:"/assets/icons/icon128.png",title:"Focus Mode Activated",message:"Notifications will be filtered for the next "+a.savedMinutes+" minutes."}),chrome.action.setBadgeText({text:"ON"}),chrome.action.setBadgeBackgroundColor({color:"#F87060"})}))}(t.taskId,t.timerType);else if("PAUSE_POMODORO"===t.action)console.log("Pausing focus session"),chrome.storage.local.get(["timerState"],(function(t){if(t.timerState&&t.timerState.savedIsActive){var e=Date.now(),r=Math.max(0,t.timerState.endTime-e),o=Math.floor(r/6e4),n=Math.floor(r%6e4/1e3),i=d(d({},t.timerState),{},{savedIsActive:!1,savedMinutes:o,savedSeconds:n,endTime:null,pausedAt:e});g=!1,chrome.storage.local.set({timerState:i}),chrome.alarms.clear("pomodoroEnd"),chrome.action.setBadgeText({text:"PAUSE"})}}));else if("RESUME_POMODORO"===t.action)console.log("Resuming focus session"),chrome.storage.local.get(["timerState"],(function(t){if(t.timerState&&!t.timerState.savedIsActive){var e=Date.now()+1e3*(60*t.timerState.savedMinutes+t.timerState.savedSeconds);g=!0;var r=d(d({},t.timerState),{},{savedIsActive:!0,endTime:e,pausedAt:null});chrome.storage.local.set({timerState:r}),chrome.alarms.create("pomodoroEnd",{when:e}),chrome.action.setBadgeText({text:"ON"})}}));else if("END_POMODORO"===t.action)p();else if("TIMER_COMPLETED"===t.action)v(t.timerType,t.taskId);else if("CLEAR_NOTIFICATIONS"===t.action)chrome.storage.local.set({notifications:[],notificationStats:{gmail:0,calendar:0}});else if("CHECK_FOCUS_MODE"===t.action)return b(t.source||"System").then((function(t){r({isBlocking:t})})),!0})),chrome.alarms.onAlarm.addListener((function(t){"pomodoroEnd"===t.name&&(console.log("Pomodoro end alarm triggered"),chrome.storage.local.get(["timerState"],(function(t){if(t.timerState&&t.timerState.savedIsActive){var e=t.timerState.savedType||"POMODORO";t.timerState.taskId,v(e)}})),function(t){w.apply(this,arguments)}(timerType))}));var y={gmail:{urlPattern:/mail\.google\.com/,extractDetails:function(t,e){return{source:"Gmail",message:e||"New Gmail notification",link:t}}},calendar:{urlPattern:/calendar\.google\.com/,extractDetails:function(t,e){return{source:"Calendar",message:e?e.replace("Google Calendar -","").trim():"New Calendar notification",link:t}}}};function b(t){return g?new Promise((function(e){chrome.storage.local.get(["timerState","notificationSettings"],(function(r){var o=r.notificationSettings||{allowFrom:["Gmail"],enableDuringBreaks:!0};if(r.timerState&&r.timerState.savedIsActive)if("SHORT_BREAK"!==r.timerState.savedType&&"LONG_BREAK"!==r.timerState.savedType||!o.enableDuringBreaks){var n=o.allowFrom.includes(t);e(!n)}else e(!1);else e(!1)}))})):Promise.resolve(!1)}function O(t){console.log("Blocking notification:",t),chrome.storage.local.get(["blockedNotifications"],(function(e){var r=e.blockedNotifications||[],o=[].concat(s(r),[d(d({},t),{},{time:Date.now(),id:Date.now().toString()})]);chrome.storage.local.set({blockedNotifications:o})}))}function S(t){console.log("Allowing notification:",t),chrome.storage.local.get(["notifications"],(function(e){var r,o=e.notifications||[];if(!o.some((function(e){return e.source===t.source&&e.message===t.message&&Date.now()-e.time<1e4}))){var n=d(d({},t),{},{time:Date.now(),id:Date.now().toString()}),i=[].concat(s(o),[n]);chrome.storage.local.set({notifications:i}),r=t.source,chrome.storage.local.get(["notificationStats"],(function(t){var e=t.notificationStats||{gmail:0,calendar:0};"Gmail"===r?e.gmail++:"Calendar"===r&&e.calendar++,chrome.storage.local.set({notificationStats:e})}))}}))}function w(){return(t=u().mark((function t(e){var r,o,n,i;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a("settings",{});case 3:if(!1!==(r=t.sent).enableSounds){t.next=6;break}return t.abrupt("return");case 6:return o=r.notificationSound||"bell",n=r.notificationVolume||70,(i=new Audio("/assets/sounds/".concat(o,".mp3"))).volume=n/100,t.next=12,i.play();case 12:console.log("Played ".concat(o," sound notification")),t.next=18;break;case 15:t.prev=15,t.t0=t.catch(0),console.error("Error playing notification sound:",t.t0);case 18:case"end":return t.stop()}}),t,null,[[0,15]])})),w=function(){var e=this,r=arguments;return new Promise((function(o,n){var i=t.apply(e,r);function a(t){f(i,o,n,a,c,"next",t)}function c(t){f(i,o,n,a,c,"throw",t)}a(void 0)}))}).apply(this,arguments);var t}chrome.webRequest.onCompleted.addListener((function(t){if(g&&(t.url.includes("notifications")||t.url.includes("mail/u")||t.url.includes("calendar/event")||t.url.includes("push")||t.url.includes("alert"))){var e=t.url,r="Unknown",o=function(o){if(y[o].urlPattern.test(e)){if(r="gmail"===o?"Gmail":"Calendar",t.tabId>0)chrome.tabs.get(t.tabId,(function(t){if(t&&t.title){var r=y[o].extractDetails(e,t.title);b(r.source).then((function(t){t?O(r):S(r)}))}}));else{var n={source:r,message:"Potential ".concat(r," notification"),link:e};b(r).then((function(t){t?O(n):S(n)}))}return 1}};for(var n in y)if(o(n))break}}),{urls:["*://*.google.com/*"]})})();